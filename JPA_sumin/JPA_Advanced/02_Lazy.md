# API 개발 고급 - 지연 로딩과 조회 성능 최적화 (10~13)

## 간단한 주문 조회 V1 : 엔티티를 직접 노출
### 주의
- 엔티티를 직접 노출할 때에는 양방향 연관관계가 걸린 곳은 꼭! 한 곳을 @JsonIgnore 해야 함. 안 그럼 무한 루프
- 엔티티를 직접 api 응답으로 외부로 노출하는 것은 안 좋음.
- DTO로 변환해서 반환하는 게 좋음
- 지연 로딩을 피하기 위해서 즉시 로딩을 설정하면 안 됨. 즉시 로딩 때문에 연관관계가 필요 없는 경우에도 데이터를 항상 조회해서
성능 저하가 발생할 수 있음.
- 항상 지연 로딩을 기본으로 하고 성능 최적화가 필요한 경우에만 페치 조인을 사용  

## 간단한 주문 조회 V2 : 엔티티를 DTO로 변환
- 엔티티를 DTO로 변환하는 일반적인 방법
- 쿼리가 총 1 + N + N번 실행
    - order 조회 한번
    - order <-> member n번
    - order -> delivery n번

## 간단한 주문 조회 V3 : 엔티티를 DTO로 변환 - 페치 조인 최적화
- 엔티티를 페치 조인을 사용해서 쿼리 1번에 조회
- 페치 조인으로 order -> member, order -> delivery 지연 로딩 발생하지 않음

## 간단한 주문 조회 V4 : JPA에서 DTO로 바로 조회
- 일반적인 sql을 사용할 때처럼 원하는 값 선택하여 조회
- new 명령어를 이용하여 JPQL의 결과를 DTO로 즉시 반환
- 리파지토리 재사용성 떨어짐. api 스펙에 맞춘 코드가 리파지토리에 들어간다는 단점
### 정리
- 엔티티를 DTO로 변환하거나, DTO로 바로 조회하는 두 가지 방법은 각각 장단점이 있음.
- 둘 중 상황에 따라 선택하면 됨.
- 엔티티로 조회하면 리파지토리 재사용성이 좋고 개발도 단순해짐.
### 권장 방법
- 우선 엔티티를 DTO로 변환하는 방법 택하기
- 필요하면 페치 조인으로 성능 최적화
- 그래도 안 되면 DTO로 직접 조회하는 방법 사용
- 최후의 방법은 JPA가 제공하는 네이티브 SQL이나 스프링 JDBC Template을 사용하여 SQL을 직접 사용